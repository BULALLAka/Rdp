name: Simple Windows RDP

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 25

    steps:
    - name: Enable RDP
      run: |
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - name: Set Password
      run: |
        net user runneradmin "Gpt12345?"

    - name: Install Chrome
      run: |
        Invoke-WebRequest "https://dl.google.com/chrome/install/375.126/chrome_installer.exe" -OutFile chrome.exe
        Start-Process chrome.exe -ArgumentList "/silent" -Wait

    - name: Download LocalXpose
      run: |
        curl -Lo loclx.zip https://api.localxpose.io/api/downloads/loclx-windows-amd64.zip
        tar -xf loclx.zip
        ren loclx-windows-amd64.exe loclx.exe

    - name: Start Tunnel for RDP (3389)
      run: |
        ./loclx.exe tunnel tcp --port 3389 --region eu &
        Start-Sleep -Seconds 8

    - name: Show RDP Info
      run: |
        ./loclx.exe status

    - name: Keep Alive (25 min)
      run: Start-Sleep -Seconds 1500
