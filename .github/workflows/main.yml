name: RDP-Loclx

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:

      - name: Enable RDP
        run: |
          Set-ItemProperty `
            -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
            -Name "fDenyTSConnections" `
            -Value 0 -Force

          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Create RDP User
        run: |
          $pass = "Qwerty123!"
          $secure = ConvertTo-SecureString $pass -AsPlainText -Force
          New-LocalUser -Name "user" -Password $secure -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "user"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "user"

          echo "USER=user" >> $env:GITHUB_ENV
          echo "PASS=$pass" >> $env:GITHUB_ENV

      - name: Download LocalXpose
        run: |
          curl -Lo loclx.zip https://api.localxpose.io/api/downloads/loclx-windows-amd64.zip
          tar -xf loclx.zip
          ren loclx.exe loclx.exe

      - name: Start LocalXpose Tunnel
        run: |
          .\loclx.exe account login --token ${{ secrets.LOCLX_TOKEN }}
          .\loclx.exe tcp --port 3389 --region eu &
          Start-Sleep -Seconds 5

      - name: Show RDP Info
        run: |
          Write-Host "======================"
          Write-Host "RDP Kullanıcı: $env:USER"
          Write-Host "RDP Şifre: $env:PASS"
          Write-Host "LocalXpose 3389 portu açıldı!"
          Write-Host "Dashboard → https://localxpose.io/dashboard"
          Write-Host "Orada sana PUBLIC HOST ve PORT verilecek."
          Write-Host "======================"

      - name: Keep Alive
        run: |
          while ($true) {
            Write-Host "RDP + LocalXpose aktif..."
            Start-Sleep -Seconds 60
          }
